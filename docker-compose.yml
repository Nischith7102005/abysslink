version: '3.8'
services:
  abysslink-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.hardened
    container_name: abysslink-backend
    restart: unless-stopped
    ports:
      - "10000:10000"
    environment:
      - NODE_ENV=production
      - PORT=10000
      - FRONTEND_URL=https://abysslink.vercel.app
    volumes:
      - abysslink_uploads:/app/uploads:ro  # Mount read-only in backend; write only via tmpfs during upload
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:10000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 2
      start_period: 10s
    networks:
      - abyssnet
    user: "1001:1001"
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,nodev,size=100m
      - /app/uploads:rw,noexec,nosuid,nodev,size=200m  # ephemeral upload buffer
    security_opt:
      - no-new-privileges:true
      - apparmor=abysslink-profile
      - seccomp=seccomp.json
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 384M
        reservations:
          cpus: '0.2'
          memory: 96M
    extra_hosts:
      - "host.docker.internal:host-gateway"
    sysctls:
      - net.ipv4.tcp_syncookies=1
      - kernel.dmesg_restrict=1
      - kernel.perf_event_paranoid=3

  abysslink-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.hardened
    container_name: abysslink-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      abysslink-backend:
        condition: service_healthy
    networks:
      - abyssnet
    user: "101:101"
    read_only: true
    tmpfs:
      - /var/cache/nginx:rw,noexec,nosuid,nodev,size=30m
      - /var/run:rw,noexec,nosuid,nodev,size=5m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE

volumes:
  abysslink_uploads:
    driver: local

networks:
  abyssnet:
    driver: bridge
    internal: true  # no external egress except backend port
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"
